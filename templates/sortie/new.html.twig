{% extends 'base.html.twig' %}

{% block title %}
    {{ parent() }} |
    {% if sortie.id != null %}
        Modifier une sortie
    {% else %}
        Créer une sortie
    {% endif %}
{% endblock %}

{% block body %}
    {% if sortie.id != null %}
        <h2>Modifier une sortie</h2>
    {% else %}
        <h2>Créer une sortie</h2>
    {% endif %}
    {{ form_start(sortieForm) }}

    {{ form_row(sortieForm.nom) }}
    {{ form_row(sortieForm.dateHeureDebut) }}
    {{ form_row(sortieForm.dateLimiteInscription) }}
    {{ form_row(sortieForm.nbInscriptionMax) }}
    {{ form_row(sortieForm.duree) }}  <span>minutes</span>
    {{ form_row(sortieForm.infosSortie) }}
    <p>Ville organisatrice : {{ app.user.campus.nom }}</p>
    <div class="ville">
        {{ form_row(sortieForm.ville) }}
    </div>
    <div class="lieu">
        {{ form_row(sortieForm.lieu) }}
        <button id="addLieu" type="button">+</button>
        {{ form_row(sortieForm.addLieu) }}
        <div id="infosLieu">
            <p id="lieuRue">Rue : {{ sortie.lieu.rue |default('') }}</p>
            <p id="lieuCodePostal">Code Postal : {{ sortie.lieu.ville.codePostal |default('') }}</p>
            <p id="lieuLatitude">Latitude : {{ sortie.lieu.latitude |default('') }}</p>
            <p id="lieuLongitude">Longitude : {{ sortie.lieu.longitude |default('') }}</p>
        </div>
    </div>

    {{ form_row(sortieForm.inscriptionAuto) }}
    {{ form_row(sortieForm.enregistrer) }}
    {{ form_row(sortieForm.publier) }}

    {{ form_end(sortieForm) }}

    {% if sortie.id != null %}
        <a href="{{ path('sortie_delete',{'id': sortie.id}) }}">
            <button>Supprimer</button>
        </a>
    {% endif %}
    <a href="{{ path('main_home') }}">
        <button>Annuler</button>
    </a>
{% endblock %}

{% block extraJs %}
    <script>
        window.onload = () => {
            // On va chercher la ville
            let ville = document.querySelector("#sortie_ville");
            ville.addEventListener("change", function () {
                let form = this.closest("form");
                let data = this.name + "=" + this.value;
                fetch(form.action, {
                    method: form.getAttribute("method"),
                    body: data,
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded; charset:UTF-8"
                    }
                })
                    .then(response => response.text())
                    .then(html => {
                        let content = document.createElement("html");
                        content.innerHTML = html;
                        let nouveauSelect = content.querySelector("#sortie_lieu");
                        console.log(nouveauSelect);
                        document.querySelector("#sortie_lieu").replaceWith(nouveauSelect);
                    })
                    .catch(error => {
                        console.log(error);
                    })
            });

            document.addEventListener('change', function (e) {
                if (e.target && e.target.id === 'sortie_lieu') {
                    let dataLieu = {lieu_id: e.target.value, like: e.target.value};
                    //utilisation de fetch pour lancer une requête asynchrone
                    fetch("{{ path('api_lieu_retrieve') }}", {method: 'POST', body: JSON.stringify(dataLieu)})
                        .then(function (response) {
                            return response.json();
                        }).then(function (dataLieu) {
                        document.getElementById("lieuRue").innerText = "Rue : " + dataLieu.rue
                        document.getElementById("lieuCodePostal").innerText = "Code Postal : " + dataLieu.codePostal
                        document.getElementById("lieuLatitude").innerText = "Latitude : " + dataLieu.latitude
                        document.getElementById("lieuLongitude").innerText = "Longitude : " + dataLieu.longitude
                    })
                }
            })

            let addLieuVisible = false;
            document.getElementById("addLieu").addEventListener("click", function (evt) {
                if (addLieuVisible) {
                    document.getElementById('sortie_addLieu').hidden = true;
                    document.getElementById('infosLieu').hidden = false;
                    addLieuVisible = false;
                } else {
                    document.getElementById('sortie_addLieu').hidden = false;
                    document.getElementById('infosLieu').hidden = true;
                    addLieuVisible = true;
                }
            });
        }
    </script>
{% endblock %}